<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Story Hub Pro</title>

<style>
body{margin:0;font-family:Segoe UI;background:#f2f2f2;display:flex;justify-content:center;align-items:center;height:100vh;}
.box{width:95%;max-width:420px;background:#fff;padding:20px;border-radius:12px;box-shadow:0 5px 10px rgba(0,0,0,.1);overflow:auto;max-height:95vh;}
input,textarea,select{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ccc;}
button{margin-top:8px;padding:10px;width:100%;border:none;border-radius:8px;background:#ff6b81;color:#fff;font-size:14px;}
.story{background:#fafafa;padding:10px;margin-top:12px;border-radius:10px;box-shadow:0 3px 8px rgba(0,0,0,.08);}
.delete{background:#ff4757;}
.logout{background:#333;}
.listen{background:#1e90ff;}
.control{background:#2ed573;}
.like{background:#ffa502;}
small{display:block;margin-top:4px;color:#666;}
</style>
</head>

<body>

<div class="box" id="loginBox">
<h2>Login / Signup</h2>
<input id="name" placeholder="Name">
<input id="pass" placeholder="Password" type="password">
<button onclick="signup()">Signup</button>
<button onclick="login()">Login</button>
</div>

<div class="box" id="app" style="display:none">
<button class="logout" onclick="logout()">Logout</button>
<h2>Story Hub Pro</h2>

<select id="voiceSelect"></select>
<select id="langSelect">
<option value="hi-IN">Hindi</option>
<option value="en-US">English</option>
</select>

<input id="title" placeholder="Story title">
<textarea id="text" rows="3" placeholder="Write story"></textarea>
<button onclick="addStory()">Upload</button>
<button class="control" onclick="readAll()">üìñ Auto Read All</button>

<div id="stories"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot,
query, orderBy, getDocs, where, updateDoc, increment
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyAtJzjzNsBvMVj6bOfByWzX21hxSAyLYVQ",
authDomain:"mini-instagram-95485.firebaseapp.com",
projectId:"mini-instagram-95485",
storageBucket:"mini-instagram-95485.firebasestorage.app",
messagingSenderId:"426906615408",
appId:"1:426906615408:web:1ba85f1d00b9c09e083eb5"
};

const appFirebase=initializeApp(firebaseConfig);
const db=getFirestore(appFirebase);

const userRef=collection(db,"users");
const storyRef=collection(db,"stories");

let currentUser=localStorage.getItem("user");

const loginBox=document.getElementById("loginBox");
const appBox=document.getElementById("app");
const stories=document.getElementById("stories");
const voiceSelect=document.getElementById("voiceSelect");
const langSelect=document.getElementById("langSelect");

function hash(p){return btoa(p);}

if(currentUser){
loginBox.style.display="none";
appBox.style.display="block";
loadStories();
}

/* signup */
window.signup=async()=>{
if(!name.value||!pass.value) return alert("Fill fields");
let q=query(userRef,where("name","==",name.value));
let snap=await getDocs(q);
if(!snap.empty) return alert("Username exists");
await addDoc(userRef,{name:name.value,pass:hash(pass.value)});
alert("Signup success");
};

/* login */
window.login=async()=>{
let q=query(userRef,where("name","==",name.value),where("pass","==",hash(pass.value)));
let snap=await getDocs(q);
if(snap.empty) return alert("Wrong login");
currentUser=name.value;
localStorage.setItem("user",currentUser);
loginBox.style.display="none";
appBox.style.display="block";
loadStories();
};

window.logout=()=>{localStorage.removeItem("user");location.reload();};

/* add story */
window.addStory=async()=>{
if(!title.value||!text.value) return;
await addDoc(storyRef,{title:title.value,text:text.value,user:currentUser,time:Date.now(),likes:0});
title.value="";text.value="";
};

/* delete */
window.del=async(id,user)=>{
if(user!==currentUser) return alert("Only your story");
await deleteDoc(doc(db,"stories",id));
};

/* like */
window.like=async(id)=>{
await updateDoc(doc(db,"stories",id),{likes:increment(1)});
};

/* voices */
let voices=[];
function loadVoices(){
voices=speechSynthesis.getVoices();
voiceSelect.innerHTML="";
voices.forEach((v,i)=>voiceSelect.innerHTML+=`<option value="${i}">${v.name}</option>`);
}
speechSynthesis.onvoiceschanged=loadVoices;
loadVoices();

/* speech controls */
window.speakStory=(title,text)=>{
speechSynthesis.cancel();
let msg=new SpeechSynthesisUtterance(title+". "+text);
msg.lang=langSelect.value;
msg.voice=voices[voiceSelect.value];
speechSynthesis.speak(msg);
};
window.pauseSpeech=()=>speechSynthesis.pause();
window.resumeSpeech=()=>speechSynthesis.resume();
window.stopSpeech=()=>speechSynthesis.cancel();

/* auto read */
window.readAll=()=>{
const all=document.querySelectorAll(".story");
let i=0;
function next(){
if(i>=all.length) return;
let t=all[i].querySelector("h3").innerText;
let p=all[i].querySelector("p").innerText;
let msg=new SpeechSynthesisUtterance(t+". "+p);
msg.lang=langSelect.value;
msg.voice=voices[voiceSelect.value];
msg.onend=()=>{i++;next();};
speechSynthesis.speak(msg);
}
next();
};

/* load stories */
function loadStories(){
const q=query(storyRef,orderBy("time","desc"));
onSnapshot(q,(snap)=>{
stories.innerHTML="";
snap.forEach(d=>{
let s=d.data();
stories.innerHTML+=`
<div class="story">
<h3>${s.title}</h3>
<p>${s.text}</p>
<small>by ${s.user}</small>
<small>‚ù§Ô∏è ${s.likes||0}</small>

<button class="listen" onclick='speakStory(${JSON.stringify(s.title)},${JSON.stringify(s.text)})'>üîä Listen</button>
<button onclick="pauseSpeech()">‚è∏ Pause</button>
<button onclick="resumeSpeech()">‚ñ∂ Resume</button>
<button onclick="stopSpeech()">‚èπ Stop</button>
<button class="like" onclick="like('${d.id}')">‚ù§Ô∏è Like</button>

${s.user===currentUser?`<button class="delete" onclick="del('${d.id}','${s.user}')">Delete</button>`:""}
</div>`;
});
});
}
</script>

</body>
</html>